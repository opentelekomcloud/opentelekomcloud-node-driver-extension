(("undefined"!==typeof self?self:this)["webpackChunkopentelekomcloud_1_0_0"]=("undefined"!==typeof self?self:this)["webpackChunkopentelekomcloud_1_0_0"]||[]).push([[916],{2317:function(e,t,o){"use strict";o.d(t,{D:function(){return i}});var a=o(4364);function s(e,t,o){return(t=r(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e){var t=n(e,"string");return"symbol"==typeof t?t:t+""}function n(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class i{constructor(e,t){s(this,"domainName",""),s(this,"endpoint",""),s(this,"projectDomainName",""),s(this,"projectId",""),s(this,"projectName",""),s(this,"username",""),s(this,"password",""),s(this,"token",""),s(this,"region",""),s(this,"catalog",void 0),s(this,"endpoints",{}),s(this,"userId",""),s(this,"vpcId",""),s(this,"$dispatch",void 0),s(this,"regionsFromCatalog",[]),t.annotations?Object.keys(t.annotations).forEach(e=>{const o=e.split("/");if(2===o.length&&"opentelekomcloud.cattle.io"===o[0]){const a=o[1];this[a]=t.annotations[e]}}):Object.keys(t).forEach(e=>{this[e]=t[e]}),this.$dispatch=e.dispatch}async getToken(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o=`${t}/auth/tokens`,s={auth:{identity:{methods:["password"],password:{user:{name:this.username,domain:{name:this.domainName},password:this.password}}}}};this.projectName?s.auth.scope={project:{name:this.projectName,...this.projectDomainName?{domain:{name:this.projectDomainName}}:{}}}:s.auth.scope={domain:{name:this.domainName}};const r={Accept:"application/json"};try{const e=await this.$dispatch("management/request",{url:o,headers:r,method:"POST",redirectUnauthorized:!1,data:s},{root:!0});return 502===e._status?{error:"Could not proxy request - URL may not be in Rancher's allow list"}:(this.token=e._headers?.["x-subject-token"],this.userId=e?.token?.user?.id,this.regionsFromCatalog=[],e?.token&&e.token.catalog&&(this.catalog=e.token.catalog,this.endpoints={},this.catalog.forEach(e=>{const t=(e.endpoints||[]).find(e=>e.region===this.region);if(t){switch(e.name){case"nova":this.endpoints.compute=t.url;break;case"vpc":this.endpoints.vpc=t.url;break;case"glance":this.endpoints.image=t.url;break;default:break}t&&"nova"===e.name&&(this.regionsFromCatalog.includes(t.region)||this.regionsFromCatalog.push(t.region))}})),this.regionsFromCatalog=this.regionsFromCatalog.map(e=>({id:e})),e)}catch(n){return a.error(n),{error:n}}}async getFlavors(e,t){return await this.getComputeOptions(e,"/flavors","flavors",void 0,t)}async getImages(e,t){return await this.getImageOptions(e,"/v2/cloudimages","images",void 0,t)}async getKeyPairs(e,t){return await this.getComputeOptions(e,"/os-keypairs","keypairs",e=>e.keypair,t)}async getSecurityGroups(e,t){return await this.getComputeOptions(e,"/os-security-groups","security_groups",void 0,t)}async getFloatingIpPools(e,t){return await this.getComputeOptions(e,"/os-floating-ip-pools","floating_ip_pools",void 0,t)}async getVpcs(e,t){return await this.getVpcOptions(e,"/vpcs","vpcs",void 0,t)}async getSubnets(e,t,o){return this.vpcId=t,await this.getVpcOptions(e,`/subnets?vpc_id=${encodeURIComponent(t)}`,"subnets",void 0,o)}async getAvailabilityZones(e,t){return await this.getComputeOptions(e,"/os-availability-zone","availabilityZoneInfo",e=>({...e,name:e.zoneName}),t)}async getImageOptions(e,t,o,a,s){e.busy=!0,e.enabled=!0,e.selected="";const r=["visibility=public","protected=true","__os_type=Linux","__os_bit=64"].join("&"),n=await this.makeImageRequest(t,`?${r}`);if(n&&n[o]){let t=n[o]||[];if(a&&(t=t.map(e=>a(e))),e.options=this.convertToOptions(t),e.busy=!1,s){const t=e.options.find(e=>e.value.name===s);t&&(e.selected=t.value)}!e.selected&&e.options.length>0&&(e.selected=e.options[0].value)}else e.options=[],e.selected=null,e.busy=!1,e.enabled=!1}async getComputeOptions(e,t,o,a,s){e.busy=!0,e.enabled=!0,e.selected="";const r=await this.makeComputeRequest(t);if(r&&r[o]){let t=r[o]||[];if(a&&(t=t.map(e=>a(e))),e.options=this.convertToOptions(t),e.busy=!1,s){const t=e.options.find(e=>e.value.name===s);t&&(e.selected=t.value)}!e.selected&&e.options.length>0&&(e.selected=e.options[0].value)}else e.options=[],e.selected=null,e.busy=!1,e.enabled=!1}async getVpcOptions(e,t,o,a,s){e.busy=!0,e.enabled=!0,e.selected="";const r=await this.makeVpcRequest(t);if(r&&r[o]){let t=r[o]||[];if(a&&(t=t.map(e=>a(e))),e.options=this.convertToOptions(t),e.busy=!1,s){const t=e.options.find(e=>e.value.name===s);t&&(e.selected=t.value)}!e.selected&&e.options.length>0&&(e.selected=e.options[0].value)}else e.options=[],e.selected=null,e.busy=!1,e.enabled=!1}async makeComputeRequest(e){const t=this.endpoints["compute"]?.replace(/^https?:\/\//,"");if(!t)return{error:"No compute endpoint discovered from catalog"};const o=`/meta/proxy/${t}`,s=`${o}${e}`,r={Accept:"application/json","X-Auth-Token":this.token};try{return await this.$dispatch("management/request",{url:s,headers:r,method:"GET",redirectUnauthorized:!1},{root:!0})}catch(n){return a.error(n),{error:n}}}async makeVpcRequest(e,t="GET",o){a.log("[OTC] makeVpcRequest: api =",e,"endpoints =",this.endpoints);const s=this.endpoints["vpc"]?.replace(/^https?:\/\//,"");if(a.log("[OTC] makeVpcRequest: ep =",s),!s)return a.error("[OTC] No VPC endpoint for region",this.region,"catalog:",this.catalog),null;const r=`/meta/proxy/${s}`,n=`${r}${e}`;a.log("[OTC] makeVpcRequest: url =",n);const i={Accept:"application/json","X-Auth-Token":this.token};try{return await this.$dispatch("management/request",{url:n,headers:i,method:t,redirectUnauthorized:!1},{root:!0})}catch(l){return a.error(l),{error:l}}}async makeImageRequest(e,t=""){const o=this.endpoints["image"]?.replace(/^https?:\/\//,"");if(!o)return{error:"No image (glance/IMS) endpoint discovered from catalog"};const s=`/meta/proxy/${o}`,r=`${s}${e}${t}`,n={Accept:"application/json","X-Auth-Token":this.token};try{return await this.$dispatch("management/request",{url:r,headers:n,method:"GET",redirectUnauthorized:!1},{root:!0})}catch(i){return a.error(i),{error:i}}}async getProjects(){const e=this.endpoint.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,o={Accept:"application/json","X-Auth-Token":this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/users/${this.userId}/projects`,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.projects}catch(s){return a.error(s),{error:s}}}async waitForVPCUp(e,t){const o=1e4;if(t||(t=Date.now()+o),Date.now()>t)throw new Error("Timeout reached while waiting for VPC to become OK");const a=await this.makeVpcRequest(`/vpcs/${e}`),s=a?.vpc?.status;if("OK"!==s)return await new Promise(e=>setTimeout(e,1e3)),this.waitForVPCUp(e,t)}async createVPC(e,t){const o={vpc:{name:e,cidr:t}},a=await this.makeVpcRequest("/vpcs","POST",o);if(a?.vpc?.id){const e=a.vpc.id;return await this.waitForVPCUp(e),e}if(a?.error)throw a.error;throw new Error("Failed to create VPC")}async waitForSubnetUp(e,t){const o=1e4;if(t||(t=Date.now()+o),Date.now()>t)throw new Error("Timeout reached while waiting for Subnet to become ACTIVE");const a=await this.makeVpcRequest(`/subnets/${e}`),s=a?.subnet?.status;if("ACTIVE"!==s)return await new Promise(e=>setTimeout(e,1e3)),this.waitForSubnetUp(e,t)}async createSubnet(e,t,o,a){const s=["100.125.4.25","8.8.8.8"],r={subnet:{name:t,cidr:o,gateway_ip:a,vpc_id:e,dnsList:s}},n=await this.makeVpcRequest("/subnets","POST",r);if(n?.subnet?.id){const e=n.subnet.id;return await this.waitForSubnetUp(e),e}if(n?.error)throw n.error;throw new Error("Failed to create Subnet")}convertToOptions(e){const t=(e||[]).sort((e,t)=>e.name.localeCompare(t.name)),o=t.map(e=>({label:e.name,value:e}));return[{label:"-- EMPTY --",value:null},...o]}}},3762:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return q}});var a=o(9274);const s={class:"row"},r={class:"col span-4"},n={class:"col span-8"},i={class:"row mt-20"},l={class:"col span-12"},c={class:"row mt-20"},d={class:"col span-6"},u={class:"row mt-20"},p={class:"col span-6"},h=["disabled"],m=["disabled"],v={key:2,class:"row mt-20"},g={class:"col span-6"};function y(e,t,o,y,w,b){const k=(0,a.resolveComponent)("LabeledSelect"),f=(0,a.resolveComponent)("LabeledInput"),N=(0,a.resolveComponent)("BusyButton"),D=(0,a.resolveComponent)("Banner");return(0,a.openBlock)(),(0,a.createElementBlock)("div",null,[(0,a.createElementVNode)("div",s,[(0,a.createElementVNode)("div",r,[(0,a.createVNode)(k,{value:w.region,"onUpdate:value":t[0]||(t[0]=e=>w.region=e),"label-key":"driver.opentelekomcloud.auth.fields.region",options:b.regionOptions,searchable:!1},null,8,["value","options"])]),(0,a.createElementVNode)("div",n,[(0,a.createVNode)(f,{value:o.value.decodedData.authUrl,disabled:!0,"label-key":"driver.opentelekomcloud.auth.fields.endpoint","placeholder-key":"driver.opentelekomcloud.auth.placeholders.endpoint",type:"text",mode:o.mode},null,8,["value","mode"])])]),(0,a.createElementVNode)("div",i,[(0,a.createElementVNode)("div",l,[(0,a.createVNode)(f,{value:o.value.decodedData.domainName,"label-key":"driver.opentelekomcloud.auth.fields.domainName","placeholder-key":"driver.opentelekomcloud.auth.placeholders.domainName",type:"text",mode:o.mode,onInput:b.onDomainNameInput},null,8,["value","mode","onInput"])])]),(0,a.createElementVNode)("div",c,[(0,a.createElementVNode)("div",d,[(0,a.createVNode)(f,{value:o.value.decodedData.username,class:"mt-20 md:mt-0","label-key":"driver.opentelekomcloud.auth.fields.username","placeholder-key":"driver.opentelekomcloud.auth.placeholders.username",type:"text",mode:o.mode,onInput:b.onUsernameInput},null,8,["value","mode","onInput"])])]),(0,a.createElementVNode)("div",u,[(0,a.createElementVNode)("div",p,[(0,a.createVNode)(f,{value:o.value.decodedData.password,"label-key":"driver.opentelekomcloud.auth.fields.password","placeholder-key":"driver.opentelekomcloud.auth.placeholders.password",type:"password",mode:o.mode,onInput:b.onPasswordInput},null,8,["value","mode","onInput"])])]),(0,a.createVNode)(N,{ref:"connect","label-key":"driver.opentelekomcloud.auth.actions.authenticate",disabled:1!==w.step||!b.canAuthenticate,class:"mt-20",onClick:b.connect},null,8,["disabled","onClick"]),(0,a.createElementVNode)("button",{class:"btn role-primary mt-20 ml-20",disabled:w.busy||1===w.step,onClick:t[1]||(t[1]=(...e)=>b.clear&&b.clear(...e))},(0,a.toDisplayString)(e.t("driver.opentelekomcloud.auth.actions.edit")),9,h),w.error?((0,a.openBlock)(),(0,a.createBlock)(D,{key:0,class:"mt-20",color:"error"},{default:(0,a.withCtx)(()=>[(0,a.createTextVNode)((0,a.toDisplayString)(w.error),1)]),_:1})):(0,a.createCommentVNode)("",!0),w.errorAllowHost?((0,a.openBlock)(),(0,a.createBlock)(D,{key:1,color:"error",class:"allow-list-error"},{default:(0,a.withCtx)(()=>[(0,a.createElementVNode)("div",null,(0,a.toDisplayString)(e.t("driver.opentelekomcloud.auth.errors.notAllowed",{hostname:b.hostname})),1),(0,a.createElementVNode)("button",{disabled:w.allowBusy,class:"btn ml-10 role-primary",onClick:t[2]||(t[2]=(...e)=>b.addHostToAllowList&&b.addHostToAllowList(...e))},(0,a.toDisplayString)(e.t("driver.opentelekomcloud.auth.actions.addToAllowList")),9,m)]),_:1})):(0,a.createCommentVNode)("",!0),w.projects?((0,a.openBlock)(),(0,a.createElementBlock)("div",v,[(0,a.createElementVNode)("div",g,[(0,a.createVNode)(k,{value:w.project,"onUpdate:value":t[3]||(t[3]=e=>w.project=e),"label-key":"driver.opentelekomcloud.auth.fields.projectName",options:b.projectOptions,searchable:!1},null,8,["value","options"])])])):(0,a.createCommentVNode)("",!0)])}var w=o(8745),b=o(9552),k=o(4992);function f(e){const t=f.options,o=t.parser[t.strictMode?"strict":"loose"].exec(e);if(!o)throw new Error(`Cannot parse as uri: ${e}`);const a={};let s=14;while(s--)a[t.key[s]]=o[s]||"";return a.query={},a.queryStr.replace(t.q.parser,(e,o,s)=>(o&&(a[t.q.name][o]=s),"")),a}f.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","queryStr","anchor"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var N=o(4220);const D=["disabled","tab-index","data-testid"],C={key:0,class:"icon icon-lg icon-spinner icon-spin"},j={key:1,class:"icon-spacer"};function V(e,t,o,s,r,n){return(0,a.openBlock)(),(0,a.createElementBlock)("button",{ref:"btn",class:"btn role-primary",disabled:o.disabled,"tab-index":o.tabIndex,"data-testid":o.componentTestid+"-async-button",onClick:t[0]||(t[0]=(...e)=>n.clicked&&n.clicked(...e))},[r.busy?((0,a.openBlock)(),(0,a.createElementBlock)("i",C)):((0,a.openBlock)(),(0,a.createElementBlock)("span",j)),(0,a.createElementVNode)("span",null,(0,a.toDisplayString)(n.displayLabel),1),t[1]||(t[1]=(0,a.createElementVNode)("span",{class:"icon-spacer"},null,-1))],8,D)}var U={props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const e=this.$store.getters["i18n/t"];return e(this.labelKey)}return this.label}},methods:{clicked(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.disabled)return;const t=()=>{this.busy=!1};this.$set(this,"busy",!0),this.$emit("click",t)},focus(){this.$refs.btn.focus()}}},$=(o(9244),o(7433));const I=(0,$.A)(U,[["render",V],["__scopeId","data-v-0b50f05a"]]);var T=I,E=o(2317),A=o(4364),O={components:{Banner:w.A,BusyButton:T,LabeledInput:b.o,LabeledSelect:k.A},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"opentelekomcloud"})},data(){const e=this.value.decodedData||{};if(this.mode!==N.YQ&&this.value.annotations){const t=this.value.annotations;e.username=t["opentelekomcloud.cattle.io/username"]||e.username,e.domainName=t["opentelekomcloud.cattle.io/domainName"]||e.domainName,e.region=t["opentelekomcloud.cattle.io/region"]||e.region,e.authUrl=t["opentelekomcloud.cattle.io/authUrl"]||e.authUrl,e.projectName=t["opentelekomcloud.cattle.io/projectName"]||e.projectName}return e.region||(e.region="eu-de"),e.authUrl=this.authUrlForRegion(e.region),this.value.setData("username",e.username||""),this.value.setData("domainName",e.domainName||""),this.value.setData("password",e.password||""),this.value.setData("region",e.region||""),this.value.setData("authUrl",e.authUrl||""),{driver:{},projects:null,step:1,busy:!1,errorAllowHost:!1,allowBusy:!1,error:"",region:e.region||"eu-de",project:e.projectName||""}},computed:{projectOptions(){const e=(this.projects||[]).sort((e,t)=>e.name.localeCompare(t.name));return e.map(e=>({label:e.name,value:e.name}))},regionOptions(){const e=[{id:"eu-de",name:"eu-de (Germany)"},{id:"eu-nl",name:"eu-nl (Netherlands)"},{id:"eu-ch2",name:"eu-ch2 (Switzerland)"}];return e.map(e=>({label:e.name,value:e.id}))},hostname(){const e=f(this.value.decodedData.authUrl);return e?.host||""},canAuthenticate(){return!!this.value?.decodedData?.domainName&&!!this.value?.decodedData?.username&&!!this.value?.decodedData?.password&&!!this.region&&!!this.value?.decodedData?.authUrl}},watch:{region(e){const t=this.authUrlForRegion(e);this.value.setData("region",e||""),this.value.setData("authUrl",t||""),this.value.decodedData.region=e,this.value.decodedData.authUrl=t}},created(){this.$emit("validationChanged",!1),this.value.annotations=this.value.annotations||{},this.value.annotations["provisioning.cattle.io/driver"]||(this.value.annotations["provisioning.cattle.io/driver"]="opentelekomcloud");const e=this.authUrlForRegion(this.region);this.value.setData("region",this.region||""),this.value.setData("authUrl",e||""),this.value.decodedData.region=this.region,this.value.decodedData.authUrl=e},methods:{authUrlForRegion(e){return e?"eu-ch2"===e?`https://iam-pub.${e}.sc.otc.t-systems.com/v3`:`https://iam.${e}.otc.t-systems.com/v3`:""},test(){this.value.annotations=this.value.annotations||{};const e=this.value.decodedData;if(this.value.annotations["opentelekomcloud.cattle.io/username"]=e.username,this.value.annotations["opentelekomcloud.cattle.io/domainName"]=e.domainName,this.value.annotations["opentelekomcloud.cattle.io/password"]=e.password,this.value.annotations["opentelekomcloud.cattle.io/region"]=e.region,this.value.annotations["opentelekomcloud.cattle.io/authUrl"]=e.authUrl,this.project){const e=this.projects?.find(e=>e.name===this.project);e&&(this.value.annotations["opentelekomcloud.cattle.io/projectName"]=e.name,this.value.setData("projectName",e.name||""),this.value.decodedData.projectName=e.name||"")}return!0},clear(){this.step=1,this.projects=null,this.errorAllowHost=!1,this.$emit("validationChanged",!1)},hostInAllowList(){if(!this.driver?.whitelistDomains)return!1;const e=f(this.value.decodedData.authUrl);return!e.host||(this.driver?.whitelistDomains||[]).includes(e.host)},async addHostToAllowList(){this.allowBusy=!0;const e=f(this.value.decodedData.authUrl);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(e.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(t){A.error("Could not update driver",t),this.allowBusy=!1}},async connect(e){this.error="",this.errorAllowHost=!1;const t=this.value.decodedData;if(!t.authUrl)return e(!1);const o=new E.D(this.$store,{endpoint:t.authUrl,domainName:t.domainName,username:t.username,password:t.password});this.allowBusy=!1,this.step=2,this.busy=!0;let a=!1;const s=await o.getToken();if(s.error)A.error(s.error),a=!1,this.step=1,this.projects=null,502!==s.error._status||this.hostInAllowList()?502===s.error._status?this.error=this.t?.("driver.opentelekomcloud.auth.errors.badGateway")||"Bad gateway when talking to OTC IAM":401===s.error._status?this.error=this.t?.("driver.opentelekomcloud.auth.errors.unauthorized")||"Unauthorized â€“ check username/password/domain":this.error=s.error.message||this.t?.("driver.opentelekomcloud.auth.errors.other")||"Unexpected error when authenticating":this.errorAllowHost=!0;else{const e=await o.getProjects();e.error?(this.error=e.error.message,a=!1):(this.projects=e,a=!0)}this.busy=!1,this.project=this.projectOptions[0]?.value;const r=a&&!!this.region;this.$emit("validationChanged",r),e(r)},onDomainNameInput(e){const t=e&&e.target?e.target.value:e;this.value.setData("domainName",t),this.value.decodedData.domainName=t},onUsernameInput(e){const t=e&&e.target?e.target.value:e;this.value.setData("username",t),this.value.decodedData.username=t},onPasswordInput(e){const t=e&&e.target?e.target.value:e;this.value.setData("password",t),this.value.decodedData.password=t}}};o(8675);const _=(0,$.A)(O,[["render",y],["__scopeId","data-v-a228763c"]]);var q=_},5548:function(e,t,o){"use strict";o.r(t);var a=o(6758),s=o.n(a),r=o(6173),n=o.n(r),i=n()(s());i.push([e.id,".icon-spacer[data-v-0b50f05a]{width:24px}",""]),t["default"]=i},8675:function(e,t,o){var a=o(9571);a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.id,a,""]]),a.locals&&(e.exports=a.locals);var s=o(4825).A;s("f8161026",a,!0,{sourceMap:!1,shadowMode:!1})},9244:function(e,t,o){var a=o(5548);a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.id,a,""]]),a.locals&&(e.exports=a.locals);var s=o(4825).A;s("14ba06c2",a,!0,{sourceMap:!1,shadowMode:!1})},9571:function(e,t,o){"use strict";o.r(t);var a=o(6758),s=o.n(a),r=o(6173),n=o.n(r),i=n()(s());i.push([e.id,".allow-list-error[data-v-a228763c]{display:flex}.allow-list-error[data-v-a228763c]>:first-child{flex:1}",""]),t["default"]=i}}]);
//# sourceMappingURL=opentelekomcloud-1.0.0.umd.min.cloud-credential.js.map